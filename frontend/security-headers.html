<!-- CSRF Token Protection -->
<!-- Add this to all your HTML pages in the <head> section -->
<meta name="csrf-token" content="">
<meta name="google-client-id" content="YOUR_GOOGLE_CLIENT_ID_HERE">

<script>
// CSRF Token Manager
class CSRFTokenManager {
  constructor() {
    this.token = null;
    this.init();
  }

  async init() {
    // Get CSRF token from server on page load
    try {
      const response = await fetch(`${window.ENV_CONFIG.apiUrl}/auth/csrf-token`, {
        credentials: 'include'
      });
      const data = await response.json();
      if (data.success && data.csrfToken) {
        this.token = data.csrfToken;
        // Update meta tag
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) {
          metaTag.setAttribute('content', this.token);
        }
      }
    } catch (error) {
      console.error('Failed to get CSRF token:', error);
    }
  }

  getToken() {
    // Try to get from meta tag first
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
      return metaTag.getAttribute('content');
    }
    return this.token;
  }

  // Add CSRF token to all state-changing requests
  addToHeaders(headers = {}) {
    const token = this.getToken();
    if (token) {
      headers['X-CSRF-Token'] = token;
    }
    return headers;
  }
}

// Initialize CSRF token manager
window.csrfTokenManager = new CSRFTokenManager();

// Override fetch to automatically add CSRF token
const originalFetch = window.fetch;
window.fetch = function(url, options = {}) {
  // Only add CSRF token for state-changing methods
  if (options.method && ['POST', 'PUT', 'DELETE', 'PATCH'].includes(options.method.toUpperCase())) {
    options.headers = window.csrfTokenManager.addToHeaders(options.headers || {});
  }
  return originalFetch(url, options);
};
</script>

<!-- Content Security Policy Enhancement -->
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               script-src 'self' 'unsafe-inline' https://accounts.google.com https://apis.google.com; 
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
               font-src 'self' https://fonts.gstatic.com; 
               img-src 'self' data: https:; 
               connect-src 'self' https://accounts.google.com https://laundry-buddy-api.onrender.com; 
               frame-src https://accounts.google.com; 
               object-src 'none'; 
               base-uri 'self';">

<!-- Additional Security Headers -->
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta name="referrer" content="strict-origin-when-cross-origin">
