<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders Debug - Laundry Buddy</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 20px; }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .section h2 { color: #555; margin-bottom: 15px; font-size: 18px; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        button.secondary { background: #2196F3; }
        button.secondary:hover { background: #0b7dda; }
        pre {
            background: #272822;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.5;
        }
        .status { 
            display: inline-block;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        #output { margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Laundry Buddy - Orders Debug Tool</h1>
        
        <div class="section">
            <h2>1. Backend Status</h2>
            <button onclick="checkBackend()">Check Backend Connection</button>
            <div id="backend-status"></div>
        </div>

        <div class="section">
            <h2>2. MongoDB Data</h2>
            <button onclick="checkMongoDB()">Check Orders in MongoDB</button>
            <button onclick="checkUsers()" class="secondary">Check Users</button>
            <div id="mongodb-status"></div>
        </div>

        <div class="section">
            <h2>3. Authentication</h2>
            <button onclick="checkAuth()">Check Login Status</button>
            <button onclick="testLogin()" class="secondary">Test Login</button>
            <div id="auth-status"></div>
        </div>

        <div class="section">
            <h2>4. Fetch Orders via API</h2>
            <button onclick="fetchOrders()">Fetch My Orders</button>
            <button onclick="createTestOrder()" class="secondary">Create Test Order</button>
            <div id="orders-status"></div>
        </div>

        <div class="section">
            <h2>5. Output</h2>
            <div id="output"></div>
        </div>
    </div>

    <!-- Include necessary scripts -->
    <script src="assests/api-config.js"></script>
    <script src="assests/order-api.js"></script>
    <script src="assests/crypto-utils.js"></script>
    <script src="assests/auth.js"></script>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const status = `<span class="status ${type}">${message}</span><br>`;
            output.innerHTML += status;
        }

        function displayJSON(data, targetId = 'output') {
            const target = document.getElementById(targetId);
            target.innerHTML += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        }

        async function checkBackend() {
            log('Checking backend...', 'info');
            try {
                const response = await fetch('http://localhost:3000/api/health');
                const data = await response.json();
                if (data.success) {
                    log('‚úÖ Backend is running!', 'success');
                    displayJSON(data, 'backend-status');
                } else {
                    log('‚ùå Backend error', 'error');
                }
            } catch (error) {
                log('‚ùå Backend not running: ' + error.message, 'error');
            }
        }

        async function checkMongoDB() {
            log('Checking MongoDB orders...', 'info');
            try {
                const response = await fetch('http://localhost:3000/api/orders', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    log(`‚úÖ Found ${data.orders.length} orders in MongoDB`, 'success');
                    displayJSON(data.orders, 'mongodb-status');
                } else {
                    log('‚ùå ' + data.message, 'error');
                }
            } catch (error) {
                log('‚ùå Error: ' + error.message, 'error');
            }
        }

        async function checkUsers() {
            log('Checking users...', 'info');
            try {
                const response = await fetch('http://localhost:3000/api/auth/me', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ User profile loaded', 'success');
                    displayJSON(data.user, 'mongodb-status');
                } else {
                    log('‚ùå Not logged in', 'error');
                }
            } catch (error) {
                log('‚ùå Error: ' + error.message, 'error');
            }
        }

        function checkAuth() {
            const authStatus = document.getElementById('auth-status');
            authStatus.innerHTML = '';
            
            if (window.authManager && window.authManager.isLoggedIn()) {
                const user = window.authManager.getCurrentUser();
                log('‚úÖ Logged in', 'success');
                displayJSON(user, 'auth-status');
            } else {
                log('‚ùå Not logged in', 'error');
                authStatus.innerHTML += '<p>Please login first</p>';
            }
        }

        async function testLogin() {
            const email = prompt('Enter email:', '240421@bmu.edu.in');
            const password = prompt('Enter password:');
            
            if (!email || !password) {
                log('‚ùå Login cancelled', 'error');
                return;
            }

            log('Attempting login...', 'info');
            try {
                const response = await fetch('http://localhost:3000/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('authToken', data.token);
                    if (window.authManager) {
                        window.authManager.setUser(data.user, data.token);
                    }
                    log('‚úÖ Login successful!', 'success');
                    displayJSON(data.user, 'auth-status');
                } else {
                    log('‚ùå Login failed: ' + data.message, 'error');
                }
            } catch (error) {
                log('‚ùå Error: ' + error.message, 'error');
            }
        }

        async function fetchOrders() {
            log('Fetching orders...', 'info');
            
            if (!window.authManager || !window.authManager.isLoggedIn()) {
                log('‚ùå Please login first', 'error');
                return;
            }

            try {
                if (window.orderManager) {
                    const orders = await window.orderManager.getOrders();
                    log(`‚úÖ Fetched ${orders.length} orders`, 'success');
                    displayJSON(orders, 'orders-status');
                } else {
                    log('‚ùå Order manager not initialized', 'error');
                }
            } catch (error) {
                log('‚ùå Error: ' + error.message, 'error');
            }
        }

        async function createTestOrder() {
            log('Creating test order...', 'info');
            
            if (!window.authManager || !window.authManager.isLoggedIn()) {
                log('‚ùå Please login first', 'error');
                return;
            }

            try {
                const orderData = {
                    serviceType: 'regular',
                    pickupDate: new Date().toISOString().split('T')[0],
                    pickupTime: '10:00',
                    deliveryDate: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    items: [{
                        type: 'regular',
                        count: 3,
                        color: 'mixed'
                    }],
                    totalAmount: 30,
                    address: 'Debug Test Room',
                    phone: '9999999999',
                    specialInstructions: 'Test order from debug page'
                };

                const response = await window.orderManager.createOrder(orderData);
                
                if (response.success) {
                    log('‚úÖ Test order created!', 'success');
                    displayJSON(response.order, 'orders-status');
                } else {
                    log('‚ùå Failed: ' + response.message, 'error');
                }
            } catch (error) {
                log('‚ùå Error: ' + error.message, 'error');
            }
        }

        // Auto-check on load
        window.addEventListener('load', () => {
            checkBackend();
            checkAuth();
        });
    </script>
</body>
</html>
